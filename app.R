
library(shiny)
library(readr)

createLink <- function(link) {
  paste0('<a href="http://wechatscope.jmsc.hku.hk:8000/html?fn=', link,
             '" target="_blank" class="btn btn-primary">查看全文</a>')
}

createLink2 <- function(link, val) {
  paste0('<a href="http://206.189.252.32:8081/', link, ".html",
             '" target="_blank" class="btn btn-primary">', val, '</a>')
}

we_ui= c("此内容因违规无法查看", "此内容被投诉且经审核涉嫌侵权，无法查看。",
         "此帐号已被屏蔽,", "该公众号已迁移", "该内容已被发布者删除")

# Define UI for data download app ----
ui <- function(input, output, session){
  
  navbarPage(
    title = 'Wechatscope',
    tabPanel('Since 2018-07-06',
             fluidRow(
               column(4,
                      selectInput("msg",
                                  "censored_msg",
                                  c("All", we_ui))
               )
             ),
             DT::dataTableOutput("table1")
             ),
    
    tabPanel('Account',
             includeHTML("form.html"),
             DT::dataTableOutput("table2")
             ),
    
    tabPanel('Download', downloadButton("downloadData", "Download"))
    )
}


# Define server logic to display and download selected file ----
server <- function(input, output, session) {
  
  wechat = reactiveFileReader(120000, session, 'ceninfo.csv', read_csv)
  
  output$table1 <- DT::renderDataTable({
    
    we = wechat()
    
    if (input$msg != "All") {
      we <- we[we$censored_msg == input$msg,]
    }

    we$nickname = createLink2(we$archive, we$nickname)    
    we$archive = createLink(we$archive)
    
    DT::datatable(we, escape = FALSE,
                  options = list(
                    order = list(5, 'desc'),
                    pageLength = 50))
  })
  
  output$table2 <- DT::renderDataTable({
    
    DT::datatable(unique(wechat()[,2]), options = list(paging = FALSE))
  })
  
  
  output$downloadData <- downloadHandler(
    filename = "wechatscope.csv",
    content = function(file) {
      write.csv(wechat(), file, row.names = FALSE)
    }
  )
  
}

# Create Shiny app ----
shinyApp(ui, server)

